<?php
namespace Home\Controller;
use Think\Controller;
class AdminController extends Controller {
	/*
	 * session admin( id , uname);
	 * cookie  id	, admin_mid
	 */
	public function __construct(){
		parent::__construct();
		if(isset($_SESSION['admin'])){
		}
		else if(isset($_COOKIE['admin_mid'])){
			/*
			 * 自动登陆
			 */
		}
		else if(in_array(GetArg('a'),array('login','register'))){
		}
		else{
			$this->display("login");
			exit;
		}



	}


	public function treeChannels($data){
		for($i=0;$i<count($data);$i++){
			$re_data=$data[$i];
			if(empty($re_data['layer'])){
				$str.=' <li class="active">
					<a href="'.$re_data['url'].'">
					<i class="'.$re_data['icon'].'"></i>
					<span class="menu-text"> '.$re_data['title'].' </span>
					</a>
					</li>
					';
			}
			else{
				$str.='
					<li>
					<a href="'.$re_data['url'].'" class="dropdown-toggle">
					<i class="'.$re_data['icon'].'"></i>
					<span class="menu-text"> '.$re_data['title'].'</span>
					<b class="arrow icon-angle-down"></b>
					</a>
					<ul class="submenu">
					';

				for($i=0;$i<count($re_data['layer']);$i++){
					$str.=self::treeChannel($re_data['layer']);
				}
				$str.="</ul>";
			}
		}
		$str.="</li>";
		return $str;
	}

	public function treeChannel($data){
		$str="";
		for($i=0;$i<count($data);$i++){
			$one=$data[$i];
			if(empty($one['parent'])&&empty($one['child'])){
				$str.=' <li class="active">
					<a href="'.$one['url'].'">
					<i class="'.$one['icon'].'"></i>
					<span class="menu-text"> '.$one['title'].' </span>
					</a>
					</li>
					';
			}
			else if(!empty($one['child']))){
			}
		}
		$str.="</li>";
		return $str;
	}
	public function insertChannel(){
		$res=M("channel")->add(array("url"=>"javascript:jump(3)","icon"=>"icon-text-width",'title'=>'酒',"child"=>""));
		var_dump($res);
	}
	public function getChannel(){
		$res=M("channel")->select();
		$str=self::treeChannel($res);
		var_dump($str);

	}
	public function index(){
		$cache_url=$_SERVER['DOCUMENT_ROOT']."/Public/Cache/";
		//$this->home_left_list=file_get_contents($cache_url."home_left_list.php");
		$str=array(
			0=>array(
				'url'=>'javascript:jump(3)',
				'icon'=>'icon-text-width',
				'title'=>'酒',
				'layer'=>'',
			),
			1=>array(
				'url'=>'javascript:jump(3)',
				'icon'=>'icon-desktop',
				'title'=>'特产',
				'layer'=>array(
					0=>array(
					'url'=>'javascript:jump(3)',
					'icon'=>'icon-text-width',
					'title'=>'酒',
					'layer'=>'',
					),
				)




			),


		);
		$this->home_left_list=self::treeChannel($str);


















		$this->display("index");
	}
	public function login(){
		if(IS_POST){
			$uname=I("post.uname");
			$pwd=I("post.pwd");
			$user=M("admin")->where("uname='$uname'")->find();
			$ext=$user['ext'];
			if($user['pwd']==md5(md5($pwd).$ext)){
				$_SESSION['admin']=array('id'=>$user['id'],'uname'=>$user['uname']);
				$this->success("登陆成功","index.php?m=Home&c=Admin&a=index");
			}
			else{
				$this->error("用户名或密码错误");
			}
			exit;
		}
		else{
			$this->display("login");
		}
	}
	/*
		+-----------+-------------+------+-----+---------+----------------+
		| Field     | Type        | Null | Key | Default | Extra          |
		+-----------+-------------+------+-----+---------+----------------+
		| id        | int(32)     | NO   | PRI | NULL    | auto_increment |
		| uname     | varchar(32) | YES  |     | NULL    |                |
		| pwd       | varchar(32) | YES  |     | NULL    |                |
		| creattime | varchar(32) | YES  |     | NULL    |                |
		| ext       | varchar(32) | YES  |     | NULL    |                |
		| email     | varchar(32) | YES  |     | NULL    |                |
		| groupid   | int(32)     | YES  |     | NULL    |                |
		+-----------+-------------+------+-----+---------+----------------+
	 */

	public function register(){
		if(IS_POST){
			$uname=I("post.uname");
			$pwd=I("post.pwd");
			$email=I("post.email");
			$groupid=0;

			$ext="";;
			for($i=0;$i<4;$i++){
				$ext.=chr(rand(97,122));

			}
			$rs=M("admin")->where("uname='$uname' or email='email'")->find();
			if(!empty($rs)){
				$this->error("用户名或邮箱已被使用");
				exit;
			}



			$data['uname']=$uname;
			$data['pwd']=md5(md5($pwd).$ext);
			$data['creattime']=time();
			$data['ext']=$ext;
			$data['email']=$email;
			$data['groupid']=$groupid;
			$rs=M("admin")->add($data);
			if($rs>0){
				$this->success("增加成功");
			}
			else{
				$this->error("增加失败");
			}
		}
		else{
			$this->display("register");
			exit;
		}

	}
	public function test(){
		$file=fopen("./data.php","r+");
		$s=array( '0'=>'1','d'=>array( '0'=>'f','a'=>array( '0'=>'4',)));
		$arr=array(
			'0'=>'1',
			'd'=>array('f','a'=>array('4')));
		$return=$this->arr($arr);
		var_dump($s);
		var_dump($return);

	}

	public function arr($param){
		$str="array(";
		foreach($param as $k => $v){
			if(is_array($v)){
				$str.="'$k'=>".$this->arr($v);
			}
			else{
				$str.="\n'$k'=>'$v',";
			}
		}
		$str.=")";
		return $str;


	}


}
